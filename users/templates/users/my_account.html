

<!-- users/templates/users/my_account.html -->
{% extends "base.html" %}
{% block title %}My Account | Mindset Playroom{% endblock %}
{% block content %}


<h1>My Account</h1>
<!-- Display messages (errors or success) -->
{% if messages %}
  <ul style="list-style: none; padding: 0;">
    {% for message in messages %}
      <li{% if message.tags %} style="color: {% if 'error' in message.tags %}red{% else %}green{% endif %};"{% endif %}>{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<p>Name: {{ user.first_name }} {{ user.last_name }}</p>
<p>Phone: {{ user.userprofile.phone_number }}</p>
<p>City/Town: {{ user.userprofile.city }}</p>


<h2>Caregivers:</h2>
<div style="display: flex; gap: 24px; align-items: center; margin-top: 20px; margin-bottom: 32px;">
  {% for cg in caregivers %}
    <div class="caregiver-avatar" data-caregiver-id="{{ cg.id }}" style="text-align: center; cursor:pointer;">
      {% if cg.avatar %}
        <img src="{{ cg.avatar.url }}" style="width: 64px; height: 64px; border-radius: 50%;" />
      {% else %}
        <div style="width:64px;height:64px; border-radius:50%; background:#def; display:flex;align-items:center;justify-content:center; font-size:2em;">{{ cg.first_name|slice:":1" }}</div>
      {% endif %}
      <div style="margin-top:4px">{{ cg }}</div>
    </div>
  {% endfor %}
  <div id="add-caregiver-btn" style="text-align: center; cursor:pointer;">
    <div style="width:64px;height:64px; border-radius:50%; background:#f2f2f2; display:flex;align-items:center;justify-content:center; font-size:2em; color:#45a; margin:0 auto;">+</div>
    <div style="margin-top:4px;color:#45a;">Add</div>
  </div>
</div>

<div id="caregiver-edit-pane" style="margin-top: 40px; display: none;">
  <h3>Edit Caregiver</h3>
  <form method="post" id="caregiver-edit-form" enctype="multipart/form-data" action="">
    {% csrf_token %}
    <input type="hidden" name="caregiver_id" id="edit-caregiver-id" value="">
    <label>First Name:
      <input type="text" name="first_name" id="edit-caregiver-first-name" value="">
    </label><br>
    <label>Last Name:
      <input type="text" name="last_name" id="edit-caregiver-last-name" value="">
    </label><br>
    <label>Phone:
      <input type="text" name="phone_number" id="edit-caregiver-phone" value="">
    </label><br>
    <label>Current Avatar:</label>
    <div id="edit-current-avatar" style="margin-bottom: 10px;"></div>
    <label>Upload New Avatar:
      <input type="file" name="avatar" id="edit-caregiver-avatar">
    </label><br><br>
    <button type="submit" id="caregiver-update-btn">Update</button>
  </form>
  <div id="caregiver-calendar-wrap" style="margin-top:32px;">
    <h3>Schedule for <span id="calendar-caregiver-name"></span></h3>
    <div class="kid-calendar-scroll">
      <div class="calendar-container" id="caregiver-calendar-container">
        <div class="calendar-nav">
          <button class="nav-arrow" id="cg-prev-month">&lt;</button>
          <span id="cg-month-year"></span>
          <button class="nav-arrow" id="cg-next-month">&gt;</button>
        </div>
        <div id="caregiver-calendar"></div>
      </div>
    </div>
  </div>
</div>

<h2>Kids:</h2>
<div style="display: flex; gap: 24px; align-items: center; margin-top: 32px; margin-bottom: 32px;">
  {% for kid in kids %}
    <div class="kid-avatar" data-kid-id="{{ kid.id }}" style="text-align: center; cursor:pointer;">
      <div style="width: 64px; height: 64px; border-radius: 50%; background: #ddd; display:flex; align-items: center; justify-content: center; font-size: 2em; margin: 0 auto;">
        {{ kid.first_name|slice:":1" }}
      </div>
      <div style="margin-top:4px">{{ kid.first_name }}</div>
      <div style="margin-top:0; font-size:0.8em; color:#666;">Birthday: {{ kid.birthday }}</div>
    </div>
  {% endfor %}
  <div id="add-kid-btn" style="text-align: center; cursor:pointer;">
    <div style="width: 64px; height: 64px; border-radius: 50%; background: #f2f2f2; display:flex; align-items: center; justify-content: center; font-size: 2em; color: #45a; margin: 0 auto;">
      +
    </div>
    <div style="margin-top:4px;color:#45a;">Add</div>
  </div>
</div>

<div id="kid-edit-pane" style="margin-top: 40px; display: none;">
  <h3>Edit Kid</h3>
  <form method="post" id="kid-edit-form" action="">
    {% csrf_token %}
    <input type="hidden" name="kid_id" id="edit-kid-id" value="">
    <label>Name:
      <input type="text" name="first_name" id="edit-kid-name" value="">
    </label><br>
    <label>Birthday:
      <input type="date" name="birthday" id="edit-kid-birthday" value="">
    </label><br>
    <button type="submit" id="update-kid-btn">Update</button>
  </form>
  <div id="kid-calendar-wrap" style="margin-top:32px;">
    <h4>Events for <span id="calendar-kid-name"></span></h4>
    <div class="kid-calendar-scroll">
      <div class="calendar-container" id="kid-calendar-container">
        <div class="calendar-nav">
          <button class="nav-arrow" id="kid-prev-month">&lt;</button>
          <span id="kid-month-year"></span>
          <button class="nav-arrow" id="kid-next-month">&gt;</button>
        </div>
        <div id="kid-calendar"></div>
      </div>

      <div id="kid-journey" style="display: none;">
        <h3 class="journey-header">Mindset Foundation Journey for <span id="journey-kid-name"></span></h3>
        <div class="swiper myJourneySwiper">
          <div class="swiper-wrapper" id="levels-wrapper"></div>
          <div class="swiper-button-prev"></div>
          <div class="swiper-button-next"></div>
          <div class="swiper-pagination"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="add-kid-modal-bg" style="display:none; position:fixed; z-index:2000; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.30);">
  <div id="add-kid-modal" style="background:#fff; width:340px; padding:32px 20px 20px; border-radius:7px; margin:60px auto 0; position:relative; box-shadow:0 3px 24px #999; min-height:180px;">
    <h3>Add Kid</h3>
    <form method="post" id="add-kid-form" action="">
      {% csrf_token %}
      <label>Name:
        <input type="text" name="first_name" id="add-kid-name" required>
      </label><br>
      <label>Birthday:
        <input type="date" name="birthday" id="add-kid-birthday" required>
      </label><br><br>
      <button type="submit">Add</button>
      <button type="button" id="cancel-add-kid" style="margin-left:8px;">Cancel</button>
    </form>
  </div>
</div>

<div id="add-caregiver-modal-bg" style="display:none; position:fixed; z-index:2000; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.30);">
  <div id="add-caregiver-modal" style="background:#fff; width:340px; padding:32px 20px 20px; border-radius:7px; margin:60px auto 0; position:relative; box-shadow:0 3px 24px #999; min-height:180px;">
    <h3>Add Caregiver</h3>
    <form method="post" id="add-caregiver-form" enctype="multipart/form-data" action="">
      {% csrf_token %}
      <input type="hidden" name="add_caregiver" value="true">
      <label>First Name:
        <input type="text" name="first_name" id="add-caregiver-first-name" required>
      </label><br>
      <label>Last Name:
        <input type="text" name="last_name" id="add-caregiver-last-name">
      </label><br>
      <label>Phone Number:
        <input type="text" name="phone_number" id="add-caregiver-phone-number">
      </label><br>
      <label>Avatar:
        <input type="file" name="avatar" id="add-caregiver-avatar">
      </label><br><br>
      <button type="submit">Add</button>
      <button type="button" id="cancel-add-caregiver" style="margin-left:8px;">Cancel</button>
    </form>
  </div>
</div>

<div id="event-modal-bg" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:3000; background:rgba(0,0,0,0.35);">
  <div id="event-modal" style="max-width:370px; width:92vw; background:#fff; border-radius:10px; box-shadow:0 3px 24px #777; padding:22px; display:flex; flex-direction:column; position:relative;">
    <button id="close-event-modal" type="button" style="position:absolute; right:14px; top:14px; border:none; background:none; font-size:1.6em; color:#666;">×</button>
    <h3 id="evt-modal-title" style="font-size:1.15em; margin-top:0; margin-bottom:.3em"></h3>
    <div style="font-size:.97em; color:#555;">
      <div><b>When:</b> <span id="evt-modal-datetime"></span></div>
      <div><b>Where:</b> <span id="evt-modal-location"></span></div>
      <div id="evt-modal-desc" style="margin-top:.6em; white-space:pre-line;"></div>
    </div>
    <button id="mark-done-btn" style="margin-top:15px; background:#28a745; color:white; border:none; border-radius:5px; padding:8px 14px; cursor:pointer; display:none;">
      Completed Today
    </button>
    <div id="mark-done-status" style="color:green; display:none; margin-top:8px;">Marked as completed!</div>
  </div>
</div>

<!-- Updated five-min-modal with dynamic routines section -->
<div id="five-min-modal-bg" aria-hidden="true">
  <div id="five-min-modal" class="modal" style="text-align: left;">
    <button id="close-five-min-modal" class="close" type="button">×</button>
    <p><b>5-Min Fun:</b> <span id="fmf-modal-name"></span></p>
    <img id="fmf-modal-photo" alt="" style="max-width: 100%; display: none;">
    <p><b>Instructions:</b> <span id="fmf-modal-instructions"></span></p>
    <audio id="fmf-modal-audio" controls style="display: none;">
      <source src="" type="audio/mpeg">
      Your browser does not support the audio element.
    </audio>
    <p><b>Place:</b> <span id="fmf-modal-place"></span></p>
    <p><b>Super Powers:</b> <span id="fmf-modal-powers"></span></p>
    <h3 id="fmf-routines-header" style="display: none;">Assigned Routines - Add to Your Kid's Routine</h3>
    <div id="fmf-routines-list"></div>
    <button id="fmf-complete-btn">Completed</button>
    <div id="fmf-complete-status">Marked as completed!</div>
  </div>
</div>

<span id="modal-trigger" class="kcal-evt" style="display:none;"></span>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/swiper@12/swiper-bundle.min.js"></script>
<script>
var userTimezone = "{{ user_timezone|escapejs }}";
var assignUrlTemplate = "{% url 'assign_routine_from_fun' 0 0 %}";

function openRoutinePopup(routine_id, fun_id) {
  var url = assignUrlTemplate.replace('0/0/', fun_id + '/' + routine_id + '/');
  window.open(url, 'routine_popup', 'width=600,height=700,scrollbars=yes,resizable=yes');
}

// Data from Django context (unchanged)
var cgCompleted = {
  {% for cg_id, comps in completed_events.items %}
    {{ cg_id }}: [
      {% for eid, day in comps %}
        { event_id: {{ eid }}, date: "{{ day }}" }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]{% if not forloop.last %},{% endif %}
  {% endfor %}
};

// Kid completions for ticks
var kidCompleted = {
  {% for kid_id, comps in kid_completed.items %}
    {{ kid_id }}: [
      {% for eid, day in comps %}
        { event_id: {{ eid }}, date: "{{ day }}" }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]{% if not forloop.last %},{% endif %}
  {% endfor %}
};

var courseLevels = {{ levels_json|safe }} || [];  // List of level objects {id, number, title, description}
var levelPoints = {{ level_points_json|safe }} || {};  // {level_id: [points {id, position, five_min_fun: {id, name, instructions, slug, ...}}]}
var kidCompletions = {{ kid_completions_json|safe }} || {};  // {kid_id: [fmf_ids completed]}
var fiveMinData = {};  // Populate from points
Object.values(levelPoints).flat().forEach(function(p) {
  if (p.five_min_fun) {
    fiveMinData[p.five_min_fun.id] = p.five_min_fun;
  }
});

var kidsData = [
  {% for kid in kids %}
    {id: {{ kid.id }}, name: "{{ kid.first_name|escapejs }}", birthday: "{{ kid.birthday }}"}{% if not forloop.last %},{% endif %}
  {% endfor %}
];
var kidEvents = {
  {% for k_id, events in kid_events.items %}
    {{ k_id }}: [
      {% for ev in events %}
      {
        id: {{ ev.id }},
        date: "{{ ev.date }}",
        name: "{{ ev.name|escapejs }}",
        desc: "{{ ev.desc|escapejs }}",
        start_time: "{{ ev.start_time|escapejs }}",
        end_time: "{{ ev.end_time|escapejs }}",
        location: "{{ ev.location|escapejs }}",
        type: "{{ ev.type|escapejs }}",  // Ensure type is passed
        utc_start: "{{ ev.utc_start|default:''|escapejs }}"  // FIXED: Add utc_start (default empty for non-events)
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]{% if not forloop.last %},{% endif %}
  {% endfor %}
};
var caregiversData = [
  {% for cg in caregivers %}
    {id: {{ cg.id }}, first_name: "{{ cg.first_name|escapejs }}", last_name: "{{ cg.last_name|escapejs }}", phone: "{{ cg.phone_number|escapejs }}", avatar: "{% if cg.avatar %}{{ cg.avatar.url }}{% endif %}"}{% if not forloop.last %},{% endif %}
  {% endfor %}
];
var cgEvents = {
  {% for cg_id, events in cg_events.items %}
    {{ cg_id }}: [
    {% for ev in events %}
      {
        id: {{ ev.id }},
        date: "{{ ev.date }}",
        name: "{{ ev.name|escapejs }}",
        desc: "{{ ev.desc|escapejs }}",
        start_time: "{{ ev.start_time|escapejs }}",
        end_time: "{{ ev.end_time|escapejs }}",
        location: "{{ ev.location|escapejs }}",
        utc_start: "{{ ev.utc_start|escapejs }}"  // FIXED: Add utc_start
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]{% if not forloop.last %},{% endif %}
  {% endfor %}
};

// Global for which CG is being shown
var currentCG = null;
var currentKid = null;

// Track current displayed month/year for kid and caregiver
var kidCurrentYear = null;
var kidCurrentMonth = null;
var cgCurrentYear = null;
var cgCurrentMonth = null;

// FIXED: Moved buildCalendar early (before load functions) for safety; removed loose 'table += ' snippet (syntax error causing disappear)
function buildCalendar(year, month, events, completedList) {
    var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    var start = new Date(year, month, 1);
    var end = new Date(year, month+1, 0);
    var eventsByDay = {};
    (events || []).forEach(function(ev){
        var parts = ev.date.split('-');
        var evDate = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
        if (evDate.getFullYear() === year && evDate.getMonth() === month) {
            var d = evDate.getDate();
            if(!eventsByDay[d]) eventsByDay[d] = [];
            eventsByDay[d].push(ev);
        }
    });
    completedList = completedList || [];
    var table = '<table class="kid-calendar-table"><tr>';
    var days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    days.forEach(function(d){ table += '<th>' + d + '</th>'; });
    table += '</tr><tr>';
    var dayOfWeek, day=1;
    for(var i=0; i<start.getDay(); ++i) table += '<td></td>';
    for(; day<=end.getDate(); ++day) {
        dayOfWeek = (start.getDay() + day - 1) % 7;
        table += '<td><span class="kcal-day-label">' + day + '</span>';
        if(eventsByDay[day]) {
            eventsByDay[day].forEach(function(ev){
                var done = completedList.some(function(cx){
                    return (String(cx.event_id) === String(ev.id)) && (cx.date === ev.date);
                });
                var evtType = ev.type || 'event';  // Default to 'event'
                table += '<span class="kcal-evt"'
                    + ' data-evt-title="' + htmlEscape(ev.name) + '"'
                    + ' data-evt-id="' + ev.id + '"'
                    + ' data-evt-type="' + evtType + '"'  // Pass type ('event' or 'routine')
                    + ' data-evt-date="' + ev.date + '"'
                    + ' data-evt-datetime="' + htmlEscape(ev.start_time) + ' — ' + htmlEscape(ev.end_time) + '"'
                    + ' data-evt-location="' + htmlEscape(ev.location || "") + '"'
                    + ' data-evt-desc="' + htmlEscape(ev.desc || "") + '"'
                    + ' data-utc-start="' + htmlEscape(ev.utc_start || "") + '"'  // FIXED: Add data-utc-start
                    + ' onclick="showEventModal(this)"'
                    + '>'
                    + (done
                        ? '<span class="kcal-tick" title="Completed today">&#x2714;&nbsp;</span>'
                        : ''
                      )
                    + htmlEscape(ev.name)
                    + '</span>';
            });
        }
        table += '</td>';
        if (dayOfWeek === 6 && day != end.getDate()) table += '</tr><tr>';
    }
    for(var j=(end.getDay() + 1); j<=6; ++j) table += '<td></td>';
    table += '</tr></table>';
    return table;
}

function getCurrentYearMonth() {
    var today = new Date();
    return {year: today.getFullYear(), month: today.getMonth()};
}

function htmlEscape(str) {
    if(!str) return '';
    return str.replace(/&/g,"&amp;")
              .replace(/</g,"&lt;")
              .replace(/>/g,"&gt;")
              .replace(/\"/g,"&quot;")
              .replace(/'/g,"&#39;");
}

// Update month/year display and rebuild calendar for kid/caregiver
function updateKidCalendar(year, month) {
    var events = kidEvents[currentKid] || [];
    var completedList = kidCompleted[currentKid] || [];
    var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    $('#kid-month-year').text(monthNames[month] + ' ' + year);
    $('#kid-calendar').html(buildCalendar(year, month, events, completedList));
    kidCurrentYear = year;
    kidCurrentMonth = month;
}

function updateCaregiverCalendar(year, month) {
    var events = cgEvents[currentCG] || [];
    var completedList = cgCompleted[currentCG] || [];
    var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    $('#cg-month-year').text(monthNames[month] + ' ' + year);
    $('#caregiver-calendar').html(buildCalendar(year, month, events, completedList));
    cgCurrentYear = year;
    cgCurrentMonth = month;
}

function loadKidCalendar(kidID) {
    var kid = kidsData.find(function(obj){ return obj.id == kidID; });
    if (kid) {
        currentKid = kidID; currentCG = null;
        $('#kid-edit-pane').show();
        $('#caregiver-edit-pane').hide();
        $('#edit-kid-id').val(kid.id);
        $('#edit-kid-name').val(kid.name);
        $('#calendar-kid-name').text(kid.name);
        var ym = getCurrentYearMonth();
        // Init current month/year
        kidCurrentYear = ym.year;
        kidCurrentMonth = ym.month;
        updateKidCalendar(ym.year, ym.month);
        if (courseLevels.length > 0) {
          $('#kid-journey').show();
          $('#journey-kid-name').text(kid.name);
          buildJourneySlider(kidID);
        } else {
          $('#kid-journey').hide();
        }
        setTimeout(function() {
            $('#edit-kid-birthday').val(kid.birthday).trigger('change');
        }, 50);
        $('.kid-avatar').removeClass('selected');
        $('.kid-avatar[data-kid-id="'+kidID+'"]').addClass('selected');
        $('.caregiver-avatar').removeClass('selected');
        localStorage.setItem('lastViewedType', 'kid');
        localStorage.setItem('lastViewedKidID', kidID);
    }
}
function loadCaregiverCalendar(cgID) {
    var cg = caregiversData.find(item => item.id == cgID);
    if (cg) {
        currentCG = cgID; currentKid = null;
        $('#caregiver-edit-pane').show();
        $('#kid-edit-pane').hide();
        $('#edit-caregiver-id').val(cg.id);
        $('#edit-caregiver-first-name').val(cg.first_name);
        $('#edit-caregiver-last-name').val(cg.last_name);
        $('#edit-caregiver-phone').val(cg.phone);
        $('#edit-current-avatar').html(cg.avatar ? '<img src="' + cg.avatar + '" style="width:100px; border-radius:5px;">' : 'None');
        $('#calendar-caregiver-name').text(cg.first_name + (cg.last_name ? ' ' + cg.last_name : ''));
        var ym = getCurrentYearMonth();
        // Init current month/year
        cgCurrentYear = ym.year;
        cgCurrentMonth = ym.month;
        updateCaregiverCalendar(ym.year, ym.month);
        $('.caregiver-avatar').removeClass('selected');
        $('.caregiver-avatar[data-caregiver-id="'+cgID+'"]').addClass('selected');
        $('.kid-avatar').removeClass('selected');
        localStorage.setItem('lastViewedType', 'caregiver');
        localStorage.setItem('lastViewedCaregiverID', cgID);
    }
}

// Navigation functions
function navigateMonth(direction, isKid) {
    if (isKid) {
        kidCurrentMonth += direction;
        if (kidCurrentMonth < 0) {
            kidCurrentMonth = 11;
            kidCurrentYear--;
        } else if (kidCurrentMonth > 11) {
            kidCurrentMonth = 0;
            kidCurrentYear++;
        }
        updateKidCalendar(kidCurrentYear, kidCurrentMonth);
    } else {
        cgCurrentMonth += direction;
        if (cgCurrentMonth < 0) {
            cgCurrentMonth = 11;
            cgCurrentYear--;
        } else if (cgCurrentMonth > 11) {
            cgCurrentMonth = 0;
            cgCurrentYear++;
        }
        updateCaregiverCalendar(cgCurrentYear, cgCurrentMonth);
    }
}

// showEventModal with type routing (like caregiver logic) - unchanged
window.showEventModal = function(elt) {
    $('#evt-modal-title').text($(elt).data('evt-title'));
    $('#evt-modal-datetime').text($(elt).data('evt-datetime'));
    $('#evt-modal-location').text($(elt).data('evt-location'));
    $('#evt-modal-desc').text($(elt).data('evt-desc'));
    $('#mark-done-status').hide();
    var evtType = $(elt).data('evt-type') || 'event';  // Default 'event'
    var evtId = $(elt).data('evt-id');
    var evtDate = $(elt).data('evt-date');
    var utcStart = $(elt).data('utc-start');  // FIXED: Now available for timed events
    var inCaregiverMode = (currentCG !== null);
    var done = $(elt).find('.kcal-tick').length > 0;  // FIXED: Check if already ticked (done)
    $('#mark-done-btn').hide();  // Initially hide
    $('#event-modal-bg').fadeIn(90);  // Show modal immediately

    // FIXED: Fetch REAL UTC from server (via API in get_current_utc)
    $.get("{% url 'get_utc' %}", function(data) {
        var currentUTCISO = data.utc_now;
        var currentUTC = new Date(currentUTCISO);
        // FIXED: Compute local date in user's timezone
        var localNow = new Date(currentUTC.toLocaleString('en-US', { timeZone: userTimezone }));
        var localDate = localNow.toISOString().split('T')[0];
        // FIXED: Determine if button should show: for timed, past start; for anytime (e.g., routine), exact local day
        var isPast = utcStart ? (currentUTCISO > utcStart) : (localDate === evtDate);
        if (isPast && !done) {  // FIXED: Add !done to prevent showing for completed
            $('#mark-done-btn').show()
                .off('click')
                .on('click', function(e){
                    e.preventDefault();
                    if (inCaregiverMode) {
                        var cgID = currentCG;
                        if (!cgID || isNaN(cgID)) {  // FIXED: Safeguard invalid ID
                            alert("Invalid caregiver selection.");
                            return;
                        }
                        var cgIDs = [cgID];
                        $.post('/events/mark_caregiver_event_completed/', {
                            caregiver_ids: cgIDs,  // FIXED: Send as list for consistency
                            event_id: evtId,
                            event_date: evtDate,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        }, function(resp){
                            if(resp.success){
                                if (!cgCompleted[cgID]) cgCompleted[cgID] = [];
                                cgCompleted[cgID].push({event_id: evtId, date: evtDate});
                                loadCaregiverCalendar(cgID);
                                $('#mark-done-status').show().delay(1000).fadeOut();
                                setTimeout(function(){ $('#event-modal-bg').fadeOut(100); }, 800);
                            } else {
                                alert("Failed to mark as completed: " + (resp.error || "Unknown error"));
                            }
                        }).fail(function(){
                            alert("Request failed. Check connection.");
                        });
                    } else {
                        var kidID = currentKid;
                        if (!kidID || isNaN(kidID)) {  // FIXED: Add similar safeguard for kid
                            alert("Invalid kid selection.");
                            return;
                        }
                        var kidIds = [kidID];  // Single kid for now
                        if (evtType === 'routine') {
                            // For routines, post to routine endpoint
                            $.post('/events/mark_kid_routine_completed/', {
                                routine_instance_id: evtId,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            }, function(resp){
                                if(resp.success){
                                    if (!kidCompleted[kidID]) kidCompleted[kidID] = [];
                                    kidCompleted[kidID].push({event_id: evtId, date: evtDate});
                                    loadKidCalendar(kidID);  // Reload to show tick
                                    $('#mark-done-status').show().delay(1000).fadeOut();
                                    setTimeout(function(){ $('#event-modal-bg').fadeOut(100); }, 800);
                                } else {
                                    alert("Failed to mark as completed: " + (resp.error || "Unknown error"));
                                }
                            }).fail(function(){
                                alert("Request failed. Check connection.");
                            });
                        } else if (evtType === 'five_min_fun') {
                            // For 5-Min Fun, post to five_min endpoint
                            $.post('/events/mark_kid_five_min_fun_completed/', {
                                five_min_fun_id: evtId,
                                kid_ids: kidIds,  // Array [currentKid]
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            }, function(resp){
                                if(resp.success){
                                    if (!kidCompleted[kidID]) kidCompleted[kidID] = [];
                                    kidCompleted[kidID].push({event_id: evtId, date: evtDate});
                                    loadKidCalendar(kidID);
                                    $('#mark-done-status').show().delay(1000).fadeOut();
                                    setTimeout(function(){ $('#event-modal-bg').fadeOut(100); }, 800);
                                } else {
                                    alert("Failed to mark as completed: " + (resp.error || "Unknown error"));
                                }
                            }).fail(function(){
                                alert("Request failed. Check connection.");
                            });
                        } else {
                            // For events (including 5-min-play Events), post to event endpoint
                            $.post('/events/mark_kid_event_completed/', {
                                event_id: evtId,
                                kid_ids: kidIds,
                                event_date: evtDate,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            }, function(resp){
                                if(resp.success){
                                    if (!kidCompleted[kidID]) kidCompleted[kidID] = [];
                                    kidCompleted[kidID].push({event_id: evtId, date: evtDate});
                                    loadKidCalendar(kidID);
                                    $('#mark-done-status').show().delay(1000).fadeOut();
                                    setTimeout(function(){ $('#event-modal-bg').fadeOut(100); }, 800);
                                } else {
                                    alert("Failed to mark as completed: " + (resp.error || "Unknown error"));
                                }
                            }).fail(function(){
                                alert("Request failed. Check connection.");
                            });
                        }
                    }
                });
        }
    }).fail(function(){
        // Fallback to browser time if fetch fails (note: this violates "no browser time" but is a rare fallback)
        var currentUTC = new Date();
        var currentUTCISO = currentUTC.toISOString();
        // FIXED: Compute local date in user's timezone
        var localNow = new Date(currentUTC.toLocaleString('en-US', { timeZone: userTimezone }));
        var localDate = localNow.toISOString().split('T')[0];
        // FIXED: Determine if button should show: for timed, past start; for anytime (e.g., routine), exact local day
        var isPast = utcStart ? (currentUTCISO > utcStart) : (localDate === evtDate);
        if (isPast && !done) {
            $('#mark-done-btn').show()
                .off('click')
                .on('click', function(e){
                    e.preventDefault();
                    if (inCaregiverMode) {
                        var cgID = currentCG;
                        if (!cgID || isNaN(cgID)) {
                            alert("Invalid caregiver selection.");
                            return;
                        }
                        var cgIDs = [cgID];
                        $.post('/events/mark_caregiver_event_completed/', {
                            caregiver_ids: cgIDs,
                            event_id: evtId,
                            event_date: evtDate,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        }, function(resp){
                            if(resp.success){
                                if (!cgCompleted[cgID]) cgCompleted[cgID] = [];
                                cgCompleted[cgID].push({event_id: evtId, date: evtDate});
                                loadCaregiverCalendar(cgID);
                                $('#mark-done-status').show().delay(1000).fadeOut();
                                setTimeout(function(){ $('#event-modal-bg').fadeOut(100); }, 800);
                            } else {
                                alert("Failed to mark as completed: " + (resp.error || "Unknown error"));
                            }
                        }).fail(function(){
                            alert("Request failed. Check connection.");
                        });
                    } else {
                        var kidID = currentKid;
                        if (!kidID || isNaN(kidID)) {
                            alert("Invalid kid selection.");
                            return;
                        }
                        var kidIds = [kidID];
                        if (evtType === 'routine') {
                            $.post('/events/mark_kid_routine_completed/', {
                                routine_instance_id: evtId,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            }, function(resp){
                                if(resp.success){
                                    if (!kidCompleted[kidID]) kidCompleted[kidID] = [];
                                    kidCompleted[kidID].push({event_id: evtId, date: evtDate});
                                    loadKidCalendar(kidID);
                                    $('#mark-done-status').show().delay(1000).fadeOut();
                                    setTimeout(function(){ $('#event-modal-bg').fadeOut(100); }, 800);
                                } else {
                                    alert("Failed to mark as completed: " + (resp.error || "Unknown error"));
                                }
                            }).fail(function(){
                                alert("Request failed. Check connection.");
                            });
                        } else if (evtType === 'five_min_fun') {
                            $.post('/events/mark_kid_five_min_fun_completed/', {
                                five_min_fun_id: evtId,
                                kid_ids: kidIds,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            }, function(resp){
                                if(resp.success){
                                    if (!kidCompleted[kidID]) kidCompleted[kidID] = [];
                                    kidCompleted[kidID].push({event_id: evtId, date: evtDate});
                                    loadKidCalendar(kidID);
                                    $('#mark-done-status').show().delay(1000).fadeOut();
                                    setTimeout(function(){ $('#event-modal-bg').fadeOut(100); }, 800);
                                } else {
                                    alert("Failed to mark as completed: " + (resp.error || "Unknown error"));
                                }
                            }).fail(function(){
                                alert("Request failed. Check connection.");
                            });
                        } else {
                            $.post('/events/mark_kid_event_completed/', {
                                event_id: evtId,
                                kid_ids: kidIds,
                                event_date: evtDate,
                                csrfmiddlewaretoken: '{{ csrf_token }}'
                            }, function(resp){
                                if(resp.success){
                                    if (!kidCompleted[kidID]) kidCompleted[kidID] = [];
                                    kidCompleted[kidID].push({event_id: evtId, date: evtDate});
                                    loadKidCalendar(kidID);
                                    $('#mark-done-status').show().delay(1000).fadeOut();
                                    setTimeout(function(){ $('#event-modal-bg').fadeOut(100); }, 800);
                                } else {
                                    alert("Failed to mark as completed: " + (resp.error || "Unknown error"));
                                }
                            }).fail(function(){
                                alert("Request failed. Check connection.");
                            });
                        }
                    }
                });
        }
    });
};

function buildJourneySlider(kidID) {
  const levels = courseLevels.map(lv => ({
    id: lv.id,
    title: `${lv.title} (${(levelPoints[lv.id] || []).length} activities)`,
    courses: (levelPoints[lv.id] || []).map(p => ({
      id: p.five_min_fun.id,
      title: p.five_min_fun.name,
      completed: (kidCompletions[kidID] || []).includes(p.five_min_fun.id)
    }))
  }));
  window.currentLevels = levels;

  const wrapper = document.getElementById('levels-wrapper');
  wrapper.innerHTML = '';
  levels.forEach(lv => wrapper.appendChild(createSlide(lv)));

  if (window.journeySwiper) {
    window.journeySwiper.destroy(true, true);
  }
  const swiper = new Swiper('.myJourneySwiper', {
    slidesPerView: 1,
    spaceBetween: 24,
    navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
    pagination: { el: '.swiper-pagination', clickable: true },
    keyboard: { enabled: true }
  });
  window.journeySwiper = swiper;

  swiper.on('slideChange', () => placePinsExact());
  setTimeout(placePinsExact, 40);
}

// SVG params
const viewW = 1200, viewH = 480;
const pad = 40;
const leftRatio = 0.08;
const rightRatio = 0.92;
const centerRatio = 0.5;
const horizontalInset = 80; // how far pins sit from horizontal ends (visual margin)

// Build path with alternating horizontals & verticals
function buildAlternatingPath(bands) {
  bands = Math.max(1, Math.floor(bands));
  const innerW = viewW - pad * 2;
  const leftX = pad + innerW * leftRatio;
  const rightX = pad + innerW * rightRatio;
  const centerX = pad + innerW * centerRatio;

  // compute bandYs
  const bandYs = [];
  for (let i=0;i<bands;i++){
    const y = pad + ((bands === 1) ? (viewH/2) : (i/(bands-1)) * (viewH - pad*2));
    bandYs.push(y);
  }

  // build path: alternate direction
  let d = '';
  for (let i=0;i<bandYs.length;i++){
    const y = bandYs[i];
    const isEven = (i % 2 === 0); // 0: left->right, 1: right->left
    const startX = isEven ? leftX : rightX;
    const endX   = isEven ? rightX : leftX;

    // horizontal segment
    d += `M ${startX.toFixed(2)} ${y.toFixed(2)} H ${endX.toFixed(2)} `;

    // vertical connector at endX down to next band's y (if exists)
    if (i < bandYs.length - 1) {
      const nextY = bandYs[i+1];
      // vertical drawn at endX
      d += `M ${endX.toFixed(2)} ${y.toFixed(2)} V ${nextY.toFixed(2)} `;
    }
  }

  return { d, geometry: { leftX, rightX, centerX, bandYs } };
}

// create slide DOM and attach geometry for pin placement
function createSlide(level) {
  const courses = level.courses || [];
  const pinsPerBand = 2;
  const bandsNeeded = Math.max(1, Math.ceil(courses.length / pinsPerBand));
  const { d, geometry } = buildAlternatingPath(bandsNeeded);

  const slide = document.createElement('div');
  slide.className = 'swiper-slide';
  slide.innerHTML = `
    <div class="slide-card">
      <h2>${level.title}</h2>
      <div class="roadmap">
        <svg viewBox="0 0 ${viewW} ${viewH}" preserveAspectRatio="xMaxYMin meet" aria-hidden="false">
          <path class="road-line" d="${d}"></path>
          <path class="road-accent" d="${d}"></path>
        </svg>
      </div>
    </div>
  `;
  slide._geometry = geometry;
  slide._bandsNeeded = bandsNeeded;
  return slide;
}

// Place pins along each horizontal exactly, following path direction
function placePinsExact() {
  const levels = window.currentLevels || [];
  document.querySelectorAll('.myJourneySwiper .swiper-slide').forEach((slide, idx) => {
    // clear pins
    slide.querySelectorAll('.pin').forEach(n => n.remove());
    const svg = slide.querySelector('svg');
    const geometry = slide._geometry;
    const bandsNeeded = slide._bandsNeeded;
    const courses = levels[idx] ? levels[idx].courses || [] : [];
    if (!geometry || !svg) return;

    const { leftX, rightX, centerX, bandYs } = geometry;

    const positions = []; // will fill according to path order
    let courseCursor = 0;
    for (let b=0;b<bandYs.length;b++){
      const y = bandYs[b];
      const isEven = (b % 2 === 0); // even: left->right
      const startX = isEven ? leftX : rightX;
      const endX   = isEven ? rightX : leftX;
      const dir = (endX - startX) >= 0 ? 1 : -1;

      // decide how many pins to place in this band
      const remain = courses.length - courseCursor;
      if (remain <= 0) break;
      if (remain === 1) {
        // single pin at midpoint along path direction
        const midX = startX + (endX - startX) * 0.5;
        positions.push({ x: midX, y, bandIndex: b });
        courseCursor += 1;
      } else {
        // two pins: at 25% and 75% along path direction, in path order
        const p1 = startX + (endX - startX) * 0.25;
        const p2 = startX + (endX - startX) * 0.75;
        // ensure path order: if dir positive (left->right) order p1 then p2; if negative, p2 then p1
        if (dir > 0) {
          positions.push({ x: p1, y, bandIndex: b });
          positions.push({ x: p2, y, bandIndex: b });
        } else {
          positions.push({ x: p2, y, bandIndex: b });
          positions.push({ x: p1, y, bandIndex: b });
        }
        courseCursor += 2;
      }
    }

    // now create SVG pins mapping to course order
    for (let i=0;i<positions.length && i<courses.length;i++){
      const pos = positions[i];
      const course = courses[i];
      if (!pos) continue;
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','pin');
      if (course.completed) g.classList.add('completed');
      g.setAttribute('transform', `translate(${pos.x}, ${pos.y})`);
      g.setAttribute('role','button');
      g.setAttribute('tabindex','0');

      // *** KEEP ONLY THIS ***
      g.innerHTML = course.completed
        ? `
          <circle class="pin-bg" r="18"></circle>
          <path class="tick" d="M -12 0 L -3 10 L 15 -10" pathLength="100"></path>
        `
        : `
          <circle class="pin-bg" r="18"></circle>
          <path class="cue" d="M -8 -12 L 14 0 L -8 12 Z"></path>
        `;


      g.addEventListener('click', ()=> openFiveMinModal(course));
      g.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') openFiveMinModal(course); });
      svg.appendChild(g);
    }
  });
}

// debounce helper
function debounce(fn, ms=100){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

// Updated openFiveMinModal
function openFiveMinModal(course) {
  var fmf = fiveMinData[course.id];
  console.log(fmf);  // Log the data for debugging to see available fields
  $('#fmf-modal-name').text(fmf.name || '');
  if (fmf.photo) {
    $('#fmf-modal-photo').attr('src', fmf.photo).attr('alt', fmf.name || '').show();
  } else {
    $('#fmf-modal-photo').hide();
  }
  $('#fmf-modal-instructions').text(fmf.instructions || '');
  if (fmf.audio) {
    $('#fmf-modal-audio source').attr('src', fmf.audio).attr('type', 'audio/mpeg');
    $('#fmf-modal-audio').show()[0].load();
  } else {
    $('#fmf-modal-audio').hide();
  }
  $('#fmf-modal-place').text(fmf.place_display || (fmf.place ? fmf.place.charAt(0).toUpperCase() + fmf.place.slice(1) : ''));
  $('#fmf-modal-powers').text(fmf.super_powers ? fmf.super_powers.join(', ') : '');
  $('#fmf-complete-status').hide();
  if (!course.completed) {
    $('#fmf-complete-btn').show().off('click').on('click', function() {
      $.post('/events/mark_kid_five_min_fun_completed/', {
        five_min_fun_id: course.id,
        kid_ids: [currentKid],
        csrfmiddlewaretoken: '{{ csrf_token }}'
      }, function(resp) {
        if (resp.success) {
          if (!kidCompletions[currentKid]) kidCompletions[currentKid] = [];
          kidCompletions[currentKid].push(course.id);
          course.completed = true;
          $('#fmf-complete-status').show().delay(1000).fadeOut();
          setTimeout(function() {
            $('#five-min-modal-bg').removeClass('open');
            placePinsExact();
          }, 800);
        } else {
          alert(resp.error || "Failed to mark completed.");
        }
      }).fail(function(){
        alert("Request failed. Check connection.");
      });
    });
  } else {
    $('#fmf-complete-btn').hide();
  }
  // Dynamic routines
  $('#fmf-routines-header').hide();
  $('#fmf-routines-list').empty();
  if (fmf.routines && fmf.routines.length > 0) {
    $('#fmf-routines-header').show();
    fmf.routines.forEach(function(r) {
      var btn = $('<button>').text('Add ' + (r.name || '') + ' to Routine').on('click', function() {
        openRoutinePopup(r.id, course.id);
      });
      $('#fmf-routines-list').append(btn).append('<br><br>');
    });
  } else {
    $('#fmf-routines-list').html('<p>No routines assigned to this 5-Min Fun.</p>');
  }
  $('#five-min-modal-bg').addClass('open');
}

$('#close-five-min-modal').on('click', function() {
  $('#five-min-modal-bg').removeClass('open');
});
$('#five-min-modal-bg').on('click', function(e) {
  if (e.target === this) $('#five-min-modal-bg').removeClass('open');
});

$(function() {

  // In my_account.html <script>, add inside $(function(){ ... })

  // Check for open_modal param to auto-open modal
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('open_modal') === 'true') {
      const instanceId = urlParams.get('routine_instance_id');
      const evtDate = urlParams.get('date');
      const kidId = parseInt(urlParams.get('kid_id'));
      if (instanceId && evtDate && kidId) {
          // Select the kid first (load calendar)
          loadKidCalendar(kidId);
          // Fetch and populate modal
          $.get(`/events/get_routine_instance/${instanceId}/`, function(data) {
              if (data.success) {
                  const trigger = $('#modal-trigger');
                  trigger.data({
                      'evt-title': data.name,
                      'evt-id': data.id,
                      'evt-type': data.type,
                      'evt-date': evtDate,
                      'evt-datetime': data.datetime,
                      'evt-location': data.location,
                      'evt-desc': data.desc,
                      'utc-start': data.utc_start
                  });
                  showEventModal(trigger[0]);
              } else {
                  alert('Failed to load routine details.');
              }
          }).fail(function() {
              alert('Request failed. Check connection.');
          });
      }
  }

    // Kid navigation buttons
    $('#kid-prev-month').on('click', function() {
        navigateMonth(-1, true);
    });
    $('#kid-next-month').on('click', function() {
        navigateMonth(1, true);
    });

    // Caregiver navigation buttons
    $('#cg-prev-month').on('click', function() {
        navigateMonth(-1, false);
    });
    $('#cg-next-month').on('click', function() {
        navigateMonth(1, false);
    });

    // Swipe support for kid calendar
    var kidTouchStartX = 0;
    var kidTouchEndX = 0;
    $('#kid-calendar-container').on('touchstart', function(e) {
        kidTouchStartX = e.originalEvent.changedTouches[0].screenX;
    });
    $('#kid-calendar-container').on('touchend', function(e) {
        kidTouchEndX = e.originalEvent.changedTouches[0].screenX;
        handleSwipe(kidTouchStartX, kidTouchEndX, true);
    });

    // Swipe support for caregiver calendar
    var cgTouchStartX = 0;
    var cgTouchEndX = 0;
    $('#caregiver-calendar-container').on('touchstart', function(e) {
        cgTouchStartX = e.originalEvent.changedTouches[0].screenX;
    });
    $('#caregiver-calendar-container').on('touchend', function(e) {
        cgTouchEndX = e.originalEvent.changedTouches[0].screenX;
        handleSwipe(cgTouchStartX, cgTouchEndX, false);
    });

    // Handle swipe gesture
    function handleSwipe(startX, endX, isKid) {
        var swipeThreshold = 50;  // Min pixels for swipe
        var diff = startX - endX;
        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                // Swipe left: next month
                navigateMonth(1, isKid);
            } else {
                // Swipe right: prev month
                navigateMonth(-1, isKid);
            }
        }
    }

    $('.kid-avatar').on('click', function(){
        var kidID = $(this).data('kid-id');
        loadKidCalendar(kidID);
    });
    $('.caregiver-avatar').on('click', function(){
        var cgID = $(this).data('caregiver-id');
        loadCaregiverCalendar(cgID);
    });

    var lastType = localStorage.getItem('lastViewedType');
    if (lastType === 'caregiver') {
        var lastCG = localStorage.getItem('lastViewedCaregiverID');
        if (lastCG && caregiversData.some(cg => cg.id == lastCG)) {
            loadCaregiverCalendar(Number(lastCG));
        } else if (caregiversData.length) {
            loadCaregiverCalendar(caregiversData[0].id);
        } else if (kidsData.length) {
            loadKidCalendar(kidsData[0].id);
        }
    } else {
        var lastKid = localStorage.getItem('lastViewedKidID');
        if (lastKid && kidsData.some(k => k.id == lastKid)) {
            loadKidCalendar(Number(lastKid));
        } else if (kidsData.length) {
            loadKidCalendar(kidsData[0].id);
        } else if (caregiversData.length) {
            loadCaregiverCalendar(caregiversData[0].id);
        }
    }

    $('#add-kid-btn').on('click', function(){
        $('#add-kid-form')[0].reset();
        $('#add-kid-modal-bg').fadeIn(100);
        $('#add-kid-name').focus();
    });
    $('#cancel-add-kid').on('click', function(){
        $('#add-kid-modal-bg').fadeOut(100);
    });
    $('#add-kid-modal-bg').on('click', function(e){
        if(e.target === this) $(this).fadeOut(100);
    });

    $('#add-caregiver-btn').on('click', function(){
        $('#add-caregiver-form')[0].reset();
        $('#add-caregiver-modal-bg').fadeIn(100);
        $('#add-caregiver-first-name').focus();
    });
    $('#cancel-add-caregiver').on('click', function(){
        $('#add-caregiver-modal-bg').fadeOut(100);
    });
    $('#add-caregiver-modal-bg').on('click', function(e){
        if(e.target === this) $(this).fadeOut(100);
    });

    $('#close-event-modal').on('click', function() {
        $('#event-modal-bg').fadeOut(90);
    });
    $('#event-modal-bg').on('click', function(e){
        if(e.target === this) $('#event-modal-bg').fadeOut(90);
    });
});

$(window).on('resize', debounce(placePinsExact, 120));
$(window).on('orientationchange', debounce(placePinsExact, 150));
</script>

{% endblock %}